{% extends "base.html" %}
{% load static %}

{% block page_header %}
    <div class="container">
        <div class="row">
            <div class="col"></div>
        </div>
    </div>
{% endblock %}

{% block content %}
  <div class="overlay"></div>
  <section class="margin-section">
    <div class="container">
      <div class="row">
          <div class="col text-center mt-3">
              <h2 class="">Subscription</h2>

              <hr class="w-25 mt-1 mb-2">
          </div>
      </div>
    <section class="container">
      <div class="mt-5">
        {% for plan in subscriptions %}
              {% if plan.image_file %}
              <a>
                <img src="{{ plan.image_file.url }}" class="img-fluid" alt="{{ plan.plan_duration }}">
              </a>
              {% else %}
                  <img src="{{ MEDIA_URL }}noimage.png" class="card-img-top img-fluid" alt="{{ plan.plan_duration }}">
              </a>
              {% endif %}
            </div>
          </section>
              <div class="container subscription">
                <h4 class="mt-5">{{ plan.plan_duration }}</h4>
                <p class="mt-2">{{ plan.description}}</p>
                {% if request.user.is_superuser %}
                  <small class="ml-3">
                      <a href="{% url 'edit_plan_admin' plan.id %}">Edit</a>
                  </small>
                {% elif user.is_authenticated %}
                    {% with subscription_order as order %}
                        {% for order in subscription_order %} 
                          {% if order.user_profile.user %}
                            <p><strong>You already has a subscription</strong></p>
                            <a class="btn btn-primary" href="{% url 'nutrition' %}" role="button">See your plan</a>
                            {% else %}
                            <a class="btn btn-primary" href="#"  id="buy_now_btn" role="button">Subscribe</a>
                          {% endif %}
                        {% endfor%}
                    {% endwith %}    
                {% else %} 
                  <a class="btn btn-primary" href="{% url 'account_signup' %}" role="button">Register to Buy</a> 
                {% endif %} 
              </div>   
        {% endfor %}
     
<hr/>
    
    <p>Get user {{user}}</p>

    {% for u in subscription_order %}
        {{u.user_profile}}
      {% endfor %}
<hr/>
    {% for order in subscription_order %}
      
      <h1>{{order.user_profile}}</h1>
      <h1>{{order.order_number}}</h1>
    {% endfor %}
  </section>  
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    <script>
      // var stripe = Stripe('{{stripe_public_key}}')
      const buy_now_button = document.querySelector('#buy_now_btn')
    
      buy_now_button.addEventListener('click', event => {   
        fetch('{% url "checkout_plan" %}', {
          headers : { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        })
        .then((result) => { return result.json() })
        .then((data) => {
          var stripe = Stripe(data.stripe_public_key);
          
          stripe.redirectToCheckout({
          // Make the id field from the Checkout Session creation API response
          // available to this file, so you can provide it as parameter here
          // instead of the {{CHECKOUT_SESSION_ID}} placeholder.
            sessionId: data.session_id
            // sessionId: '{{session_id}}'
          }).then(function (result) {
            // If `redirectToCheckout` fails due to a browser or network
            // error, display the localized error message to your customer
            // using `result.error.message`.
          });
        }) 
      })
    </script>
{% endblock %}




